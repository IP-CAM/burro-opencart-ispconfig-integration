<modification>
	<id>VQMOD - burro: opencart ispconfig integration</id>
	<version>1.5.5.1</version>
	<vqmver>2.3.2</vqmver>
	<author>Federico Carrara</author>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- #####################################  SYSTEM  ############################################################################## -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	
	
	
	
	
	
	
	
	<!-- ############################################################################################################################# -->
	<!-- #####################################  LIBRARY  ############################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- add logVar to log -->
	<file name="system/library/log.php">
		<operation>
			<search position="replace"><![CDATA[public function write($message) {]]></search>
			<add><![CDATA[public function writeVar($var) {
		ob_start();
		var_dump($var);
		$message = ob_get_contents();
		ob_end_clean();
		$file = DIR_LOGS . $this->filename;
		$handle = fopen($file, 'a+'); 
		fwrite($handle, date('Y-m-d G:i:s') . ' - ' . $message . "\n");
		fclose($handle); 

	}
			
	public function write($message) {]]></add>
		</operation>
	</file>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- #####################################  ADMIN  ############################################################################### -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	
	
	
	
	
	
	
	
	<!-- ############################################################################################################################# -->
	<!-- #####################################  PRODUCT CONTROLLER  ################################################################## -->
	<!-- ############################################################################################################################# -->
	<!-- add Burro to product controller -->
	<file name="admin/controller/catalog/product.php">
		<!-- getForm -->
		<operation>
			<search position="replace"><![CDATA[$this->data['button_add_special'] = $this->language->get('button_add_special');]]></search>
			<add><![CDATA[$this->data['button_add_hosting'] = 'Add Service';
		$this->data['button_add_special'] = $this->language->get('button_add_special');]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[$this->data['tab_special'] = $this->language->get('tab_special');]]></search>
			<add><![CDATA[$this->data['tab_hosting'] = 'Hostings';
		$this->data['tab_special'] = $this->language->get('tab_special');]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[if (isset($this->request->post['product_special'])) {]]></search>
			<add><![CDATA[if (isset($this->request->post['product_hosting'])) {
			$this->data['product_hostings'] = $this->request->post['product_hosting'];
		} elseif (isset($this->request->get['product_id'])) {
			$this->data['product_hostings'] = $this->model_catalog_product->getProductHostings($this->request->get['product_id']);
		} else {
			$this->data['product_hostings'] = array();
		}
		
		if (isset($this->request->post['product_special'])) {]]></add>
		</operation>
		
	</file>
	
	
	
	
	
	
	
	
	<!-- ############################################################################################################################# -->
	<!-- #####################################  PRODUCT MODEL  ####################################################################### -->
	<!-- ############################################################################################################################# -->
	<!-- add Burro to product model -->
	<file name="admin/model/catalog/product.php">
		<!-- insert of new product -->
		<!-- note: this replace should take place 2 times in this file	-->
		<operation>
			<search position="replace"><![CDATA[if (isset($data['product_special'])) {]]></search>
			<add><![CDATA[if (isset($data['product_hosting'])) {
			foreach ($data['product_hosting'] as $product_hosting) {
				$this->db->query("INSERT INTO " . DB_PREFIX . "product_hosting SET product_id = '" . (int)$product_id . "', service = '" . $product_hosting['service'] . "', duration = '" . (int)$product_hosting['duration'] . "', size = '" . (int)$product_hosting['size'] . "', extensions = '" . $product_hosting['extensions'] . "', quantity = '" . $product_hosting['quantity'] . "'" );
			}
		}
		if (isset($data['product_special'])) {]]></add>
		</operation>
		
		<!-- delete of a product -->
		<!-- note: this replace should take place 2 times in this file	-->
		<operation>
			<search position="replace"><![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "product_special WHERE product_id = '" . (int)$product_id . "'");]]></search>
			<add><![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "product_hosting WHERE product_id = '" . (int)$product_id . "'");
		$this->db->query("DELETE FROM " . DB_PREFIX . "product_special WHERE product_id = '" . (int)$product_id . "'");]]></add>
		</operation>
		
		<!-- copy of a product -->
		<operation>
			<search position="replace"><![CDATA[$data = array_merge($data, array('product_special' => $this->getProductSpecials($product_id)));]]></search>
			<add><![CDATA[$data = array_merge($data, array('product_hosting' => $this->getProductHostings($product_id)));
			$data = array_merge($data, array('product_special' => $this->getProductSpecials($product_id)));]]></add>
		</operation>
		
		<!-- get a product -->
		<operation>
			<search position="replace"><![CDATA[public function getProductSpecials($product_id) {]]></search>
			<add><![CDATA[public function getProductHostings($product_id) {
		$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_hosting WHERE product_id = '" . (int)$product_id . "' ORDER BY product_hosting_id");
		return $query->rows;
	}
	public function getProductSpecials($product_id) {]]></add>
		</operation>
	</file>
	
	
	
	
	
	
	
	
	<!-- ############################################################################################################################# -->
	<!-- #####################################  PRODUCT VIEW   ####################################################################### -->
	<!-- ############################################################################################################################# -->
	<!-- add Burro view to admin product template -->
	<file name="admin/view/template/catalog/product_form.tpl">
		<operation>
			<search position="replace"><![CDATA[<a href="#tab-design"><?php echo $tab_design; ?></a>]]></search>
			<add><![CDATA[<a href="#tab-design"><?php echo $tab_design; ?></a><a href="#tab-hosting">Hostings</a>]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[<div id="tab-design">]]></search>
			<add><![CDATA[<div id="tab-hosting">
          <table id="hosting" class="list">
            <thead>
              <tr>
                <td class="left">Service:</td>
                <td class="right">Duration (months):<br/><span class="help">Mandatory for all services.</span></td>
                <td class="right">Size (GBytes):<br/><span class="help">Used only for services "Web Hosting Additional Space", "Web Hosting Additional Traffic" and "Mailbox Additional Space".</span></td>
                <td class="right">Allowed domain extensions:<br/><span class="help">Used only for service "Domain Name".<br/>Multiple allowed, comma separated<br/>Ex.: it,com,net,org,info</span></td>
                <td class="right">Quantity:<br/><span class="help">Used only for service "Mailbox".</span></td>
                <td></td>
              </tr>
            </thead>
            <?php $hosting_row = 0; ?>
            <?php foreach ($product_hostings as $product_hosting) { ?>
            <tbody id="hosting-row<?php echo $hosting_row; ?>">
              <tr>
                <td class="left"><select name="product_hosting[<?php echo $hosting_row; ?>][service]">
                    <option value="domain" <?php if ( $product_hosting['service'] == 'domain' ) echo ' selected="selected" '; ?> >Domain Name</option>
                    <option value="webhosting" <?php if ( $product_hosting['service'] == 'webhosting' ) echo ' selected="selected" '; ?> >Web Hosting</option>
                    <option value="webhosting_space" <?php if ( $product_hosting['service'] == 'webhosting_space' ) echo ' selected="selected" '; ?> >Web Hosting Additional Space</option>
                    <option value="webhosting_traffic" <?php if ( $product_hosting['service'] == 'webhosting_traffic' ) echo ' selected="selected" '; ?> >Web Hosting Additional Traffic</option>
                    <option value="mailbox" <?php if ( $product_hosting['service'] == 'mailbox' ) echo ' selected="selected" '; ?> >Mailbox</option>
                    <option value="mailbox_space" <?php if ( $product_hosting['service'] == 'mailbox_space' ) echo ' selected="selected" '; ?> >Mailbox Additional Space</option>
                    <option value="database" <?php if ( $product_hosting['service'] == 'database' ) echo ' selected="selected" '; ?> >Database</option>
                  </select></td>
                <td class="right"><input type="text" name="product_hosting[<?php echo $hosting_row; ?>][duration]" value="<?php echo $product_hosting['duration']; ?>" size="2" /></td>
                <td class="right"><input type="text" name="product_hosting[<?php echo $hosting_row; ?>][size]" value="<?php echo $product_hosting['size']; ?>" size="2" /></td>
                <td class="right"><input type="text" name="product_hosting[<?php echo $hosting_row; ?>][extensions]" value="<?php echo $product_hosting['extensions']; ?>" /></td>
                <td class="right"><input type="text" name="product_hosting[<?php echo $hosting_row; ?>][quantity]" value="<?php echo $product_hosting['quantity']; ?>" size="2" /></td>
                <td class="left"><a onclick="$('#hosting-row<?php echo $hosting_row; ?>').remove();" class="button"><?php echo $button_remove; ?></a></td>
              </tr>
            </tbody>
            <?php $hosting_row++; ?>
            <?php } ?>
            <tfoot>
              <tr>
                <td colspan="5"></td>
                <td class="left"><a onclick="addHosting();" class="button"><?php echo $button_add_hosting; ?></a></td>
              </tr>
            </tfoot>
          </table>
        </div>
        <div id="tab-design">]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[var special_row = <?php echo $special_row; ?>;]]></search>
			<add><![CDATA[var hosting_row = <?php echo $hosting_row; ?>;
function addHosting() {
	html  = '<tbody id="hosting-row' + hosting_row + '">';
	html += '  <tr>'; 
    html += '    <td class="left"><select name="product_hosting[' + hosting_row + '][service]">';
    html += '      <option value="domain">Domain Name</option>';
    html += '      <option value="webhosting">Web Hosting</option>';
    html += '      <option value="webhosting_space">Web Hosting Additional Space</option>';
    html += '      <option value="webhosting_traffic">Web Hosting Additional Traffic</option>';
    html += '      <option value="mailbox">Mailbox</option>';
    html += '      <option value="mailbox_space">Mailbox Additional Space</option>';
    html += '      <option value="database">Database</option>';
    html += '    </select></td>';		
    html += '    <td class="right"><input type="text" name="product_hosting[' + hosting_row + '][duration]" value="" size="4" /></td>';
	html += '    <td class="right"><input type="text" name="product_hosting[' + hosting_row + '][size]" value="" size="4" /></td>';
    html += '    <td class="right"><input type="text" name="product_hosting[' + hosting_row + '][extensions]" value=""  size="16" /></td>';
    html += '    <td class="right"><input type="text" name="product_hosting[' + hosting_row + '][quantity]" value=""  size="4" /></td>';
	html += '    <td class="left"><a onclick="$(\'#hosting-row' + hosting_row + '\').remove();" class="button"><?php echo $button_remove; ?></a></td>';
	html += '  </tr>';
    html += '</tbody>';
	$('#hosting tfoot').before(html);
	hosting_row++;
}
var special_row = <?php echo $special_row; ?>;]]></add>
		</operation>
	</file>
	<!-- ############################################################################################################################# -->
	<!-- #####################################  COMMON VIEW   ######################################################################## -->
	<!-- ############################################################################################################################# -->
	<!-- add Burro section to main menu -->
	<file name="admin/view/template/common/header.tpl">
		<operation>
			<search position="replace"><![CDATA[<li id="help">]]></search>
			<add><![CDATA[<li id="hosting"><a class="top">Hostings</a>
        <ul>
          <li><a href="<? echo $this->url->link('burro/config', 'token=' . $this->session->data['token'], 'SSL'); ?>">Configuration</a></li>
          <li><a href="<? echo $this->url->link('burro/services', 'token=' . $this->session->data['token'], 'SSL'); ?>">Services</a></li>
          <li><a href="<? echo $this->url->link('burro/home', 'token=' . $this->session->data['token'], 'SSL'); ?>">About burro</a></li>
        </ul>
      </li>
      <li id="help">]]></add>
		</operation>
	</file>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- #####################################  CATALOG  ############################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- ############################################################################################################################# -->
	
	
	
	
	
	
	
	
	<!-- ############################################################################################################################# -->
	<!-- #####################################  PRODUCT CONTROLLER  ################################################################## -->
	<!-- ############################################################################################################################# -->
	<!-- add loading of hosting data in product controller -->
	<file name="catalog/controller/product/product.php">
		<operation>
			<search position="replace"><![CDATA[if ($product_info) {]]></search>
			<add><![CDATA[if ($product_info) {
			
			//first see if my product is a hosting product
			$this->load->model('burro/hosting');
			$this->data['product_hostings'] = $this->model_burro_hosting->getProductHostings($product_id);
			//search if between hostings, there is a domain service
			$this->data['product_hostings_have_domain'] = $this->model_burro_hosting->productHostingsContainDomain($this->data['product_hostings']);
			//search all domain services and mailboxes already activated for this user
			$customer_id = $this->customer->isLogged();
			if ( $customer_id ) {
				$this->data['avail_domains'] = $this->model_burro_hosting->getHostings(array('new','active'),array('domain'),0,$customer_id);
				$this->data['avail_mailboxes'] = $this->model_burro_hosting->getMailboxes($customer_id);
			} else {
				$this->data['avail_domains'] = array(  );
				$this->data['avail_mailboxes'] = array(  );
			}
			
]]></add>
		</operation>
	</file>
	
	
	
	
	
	
	
	
	<!-- ############################################################################################################################# -->
	<!-- #####################################  CHECKOUT CONTROLLER  ################################################################# -->
	<!-- ############################################################################################################################# -->
	<!-- add to cart controller the redirect to product detail when hosting products (with hosting options) are added to cart -->
	<file name="catalog/controller/checkout/cart.php">
		<operation>
			<search position="replace"><![CDATA[$product_options = $this->model_catalog_product->getProductOptions($this->request->post['product_id']);]]></search>
			<add><![CDATA[
			//only redirect addToCart to product detail if I am not already in product detail
			$this->log->write("0");
			$this->log->writeVar($this->request->post);
			//I am in the product detail if some POST vars are defined
			//so if they aren't, I'm not the product detail page
			if ( !isset($this->request->post["is_hosting"] ) ) {
				//first see if my product is a hosting product
				$this->log->write("1");
				$this->load->model('burro/hosting');
				$this->log->write("2");
				$product_hostings = $this->model_burro_hosting->getProductHostings($this->request->post['product_id']);
				$this->log->writeVar($this->request->post['product_id']);
				$this->log->writeVar($product_hostings);
				//search if between hostings, if there are some that require interaction from customer
				//note: right now only 'mailbox' service doesn't require user interaction
				$this->log->write("3");
				foreach ( $product_hostings as $hosting ) {
					$this->log->write("4");
					if ( $hosting['service']!="mailbox" ) {
						$this->log->write("5!");
						$json['burro"]["error'] = 'must redirect to product detail';
					}
				}
				$this->log->write("6");
			} elseif ( isset($this->request->post["is_hosting"] ) && $this->request->post["is_hosting"] == "yes" ) {
				//if I'm in the product page, must validate hosting parameters
				//first see if my product is a hosting product
				$this->load->model('burro/hosting');
				$product_hostings = $this->model_burro_hosting->getProductHostings($this->request->post['product_id']);
				foreach ( $product_hostings as $hosting ) {
					$this->log->write("7");
					if ( $hosting['service']=="domain" && ( !isset($this->request->post["hosting_domain"] ) || $this->request->post["hosting_domain"] == "" ) ) {
						$this->log->write("8!");
						$json['burro"]["error'] = 'domain is required';
					} elseif ( $hosting['service']=="mailbox_space" && ( !isset($this->request->post["hosting_mailbox_selected"] ) || $this->request->post["hosting_mailbox_selected"] == ""  ) ) {
						$this->log->write("9!");
						$json['burro"]["error'] = 'mailbox is required';
					} elseif ( ( $hosting['service']=="webhosting" || $hosting['service']=="webhosting_space" || $hosting['service']=="database" || $hosting['service']=="traffic" ) && ( !isset($this->request->post["hosting_domain_selected"] ) || $this->request->post["hosting_domain_selected"] == "" ) ) {
						$this->log->write("10!");
						//search if my product has also a domain hosting service in it: if it has, theres no need to validate user input
						if ( !$this->model_burro_hosting->productHostingsContainDomain($product_hostings) ) {
							$json['burro"]["error'] = 'domain is required';
						}
					}
				}
			}
			
			$product_options = $this->model_catalog_product->getProductOptions($this->request->post['product_id']);]]></add>
		</operation>
	</file>
	
	
	
	
	
	
	
	
	<!-- ############################################################################################################################# -->
	<!-- #####################################  DEFAULT THEME  ####################################################################### -->
	<!-- ############################################################################################################################# -->
	<!-- add Burro javascript to catalog header tpl -->
	<file name="catalog/view/theme/*/template/common/header.tpl">
		<operation>
			<search position="replace"><![CDATA[</head>]]></search>
			<add><![CDATA[<script type="text/javascript" src="catalog/view/javascript/burro.js"></script>
</head>]]></add>
		</operation>
	</file>
	<!-- add Hosting section in product tpl -->
	<file name="catalog/view/theme/*/template/product/product.tpl">
		<operation>
			<search position="replace"><![CDATA[<div class="cart">]]></search>
			<add><![CDATA[
      <?php if (count($product_hostings)>0) { ?>
      <div class="price hosting_section">
	  <input type="hidden" name="is_hosting" value="yes"/>
        <table>
      <?php 	foreach ( $product_hostings as $hosting ) { ?>
          <tr>
      <?php 		if ( isset( $hosting['service'] ) && $hosting['service']=="domain" ) { ?>
            <td valign="top"><h2>domain</h2><span class='help'>type the domain name you would like to register, choosing an extension within those available in the combo menu on the right (do not write extension within domain name)</span></td>
            <td valign="top">
              <input type="text" name="hosting_domain" id="hosting_domain" size="40" />
              <script>
              $('#hosting_domain').keyup(function() {
			  if ( $('#hosting_domain').val() == "" ) {
				$('#hosting_domain_error').show();
			  } else {
				$('#hosting_domain_error').hide();
			  }
              });
              </script>
      <?php 			if ( !isset( $this->request->post["hosting_domain"] ) || $this->request->post["hosting_domain"] == "" ) { ?>
              <span class="hosting-error" id="hosting_domain_error">domain is required!</span>
      <?php 			} ?>
            </td>
            <td valign="top">
              <br/>&nbsp;.&nbsp;
            </td>
            <td valign="top">
              <select name="hosting_domain_extension">
      <?php 				foreach ( explode(",",$hosting["extensions"]) as $extension ) { ?>
                <option value="<?php echo $extension; ?>"><?php echo $extension; ?></option>
      <?php 				} ?>
              </select>
            </td>
      <?php 		} elseif ( ( $hosting['service']=="webhosting" || $hosting['service']=="webhosting_space" || $hosting['service']=="database" || $hosting['service']=="traffic" ) && !$product_hostings_have_domain ) { ?>
            <td valign="top"><h2>domain</h2><span class='help'>choose the domain name for this service</span></td>
            <td valign="top">
      <?php 			if ( count( $avail_domains ) > 0 ) {  ?>
              <select name="hosting_domain_selected">
      <?php 				foreach ( $avail_domains as $avail_domain ) { ?>
                <option value="<?php echo $avail_domain["domain"]; ?>"><?php echo $avail_domain["domain"]; ?></option>
      <?php 				} ?>
              </select>
      <?php 			} else {  ?>
              <span class="hosting-error">first you must add to cart a domain, then you'll be able to add services to that domain.</span>	  
      <?php 			}  ?>
            </td>
      <?php 		} elseif ( $hosting['service']=="mailbox_space" ) { ?>
            <td valign="top"><h2>email</h2><span class='help'>on which mailbox you need additional space?</span></td>
            <td valign="top">
      <?php 			if ( count( $avail_mailboxes ) > 0 ) {  ?>
              <select name="hosting_mailbox_selected">
      <?php 				foreach ( $avail_mailboxes as $avail_mailbox ) { ?>
                <option value="<?php echo $avail_mailbox["email"]; ?>"><?php echo $avail_mailbox["email"]; ?></option>
      <?php 				} ?>
              </select>
      <?php 			} else {  ?>
              <span class="hosting-error">you must be logged in, and already have bought a mailbox, then you'll be able to add more space to it.</span>	  
      <?php 			}  ?>
            </td>
      <?php 		} ?>
          </tr>
      <?php 	} ?>
        </table>
      </div>
      <?php } ?>
      <div class="cart">]]></add>
		</operation>
	</file>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
</modification>